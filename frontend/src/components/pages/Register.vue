<script setup lang="ts">
import { ref } from "vue";
import useAuth from "@/hooks/auth/useAuth";
import router from "@/router";
import { API_BASE } from "@/utils/constants";
import { type ErrorResponse, Schemas } from "@/utils/schemas";

const emit = defineEmits(["submit"]);
const { setUser } = useAuth();
const error = ref<ErrorResponse>();
const formData = ref<{
	email: string;
	password: string;
	confirmPassword: string;
}>({
	email: "",
	password: "",
	confirmPassword: "",
});

async function signup() {
	const reqBody = {
		email: formData.value.email,
		password: formData.value.password,
		confirm_password: formData.value.confirmPassword,
	};
	emit("submit", { ...reqBody });

	const res = await fetch(`${API_BASE}/users/signup`, {
		method: "POST",
		headers: {
			"Content-Type": "application/json",
		},
		body: JSON.stringify(reqBody),
	});
	const json: unknown = await res.json();
	if (!res.ok) {
		error.value = json as ErrorResponse;
		return;
	}
	const parsed = Schemas.UserSchema.parse(json);
	setUser(parsed);
	error.value = undefined;
	router.push({ name: "Home" });
}
</script>

<template>
  <Box bg="darkest" width="w-full" height="h-full" class="items-center">
    <Text as="h3" size="3xl"> Sign in to your account </Text>
    <form @submit.prevent="signup" class="w-4/5 sm:w-2/5 flex flex-col gap-4">
      <InputField
        bg="primary"
        text-color="dark"
        type="email"
        v-model="formData.email"
        errorslot
      >
        <template #label><Text>Email</Text></template>
        <template v-if="error?.errors?.email" #error>
          <Text color="error">{{ error?.errors?.email }}</Text>
        </template>
      </InputField>
      <InputField
        text-color="dark"
        bg="primary"
        type="password"
        v-model="formData.password"
        errorslot
      >
        <template #label><Text>Password</Text></template>
        <template v-if="error?.errors?.password" #error>
          <Text color="error">{{ error?.errors?.password }}</Text>
        </template>
      </InputField>
      <InputField
        text-color="dark"
        bg="primary"
        type="password"
        v-model="formData.confirmPassword"
        errorslot
      >
        <template #label><Text>Confirm Password</Text></template>
        <template v-if="error?.errors?.confirm_password" #error>
          <Text color="error">{{ error?.errors?.confirm_password }}</Text>
        </template>
      </InputField>
      <Button class="mt-4" height="h-10" width="w-full">
        <Text>Register</Text>
      </Button>
    </form>
    <Text v-if="error" as="p" size="sm" color="error">
      {{ error?.message }}
    </Text>
  </Box>
</template>
